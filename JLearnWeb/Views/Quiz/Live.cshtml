@model DL.Quiz
@section scripts
{
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $(function () {
            // Reference the auto-generated proxy for the hub.
            var quiz = $.connection.quizHub;
            // Create a function that the hub can call back to display messages.
            quiz.client.setQuestion = function (quizId, question) {
                // Add the message to the page.
                var currentQuiz = @Model.QuizID;
                if(quizId == currentQuiz) {
                    var qsn = JSON.parse(question);
                    displayQuestion(qsn);
                }
            };
            quiz.client.notify = function (type, message) {
                if(type == "Success") {
                    $('#notification').html('<div class="alert alert-success alert-dismissable in"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong><span class="glyphicon glyphicon-ok"></span> Success! </strong><p>' + message + '</p></div>');
                    $("#choice :input").attr("disabled", true);
                    $("#button-footer :button").attr("disabled", true);
                } else {
                    $('#notification').html('<div class="alert alert-danger alert-dismissable in"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong><span class="glyphicon glyphicon-remove"></span> Error: </strong><p>' + message + '</p></div>');
                }
            }
            @if (Context.User.IsInRole(JLearnWeb.Constant.ConstantFields.Lecturer))
            {
                @: quiz.client.setStats = function(quizId, stats) {
                @:    var currentQuiz = @Model.QuizID;
                @:    if (quizId == currentQuiz) {
                @:        drawChart(JSON.parse(stats));
                @:    }
                @: }
            }
            // Start the connection.
            $.connection.hub.start().done(function () {
                $('#next').click(function () {
        quiz.server.next(@Model.QuizID);
    });
                $('#prev').click(function () {
                quiz.server.prev(@Model.QuizID);
            });
                $('#submitAnswer').click(function () {
                var questionId = $('#questionId').val();
                var userId = @ViewBag.UserId;
                var answer = $('input[name=optionsRadios]:checked', '#choice').val();
                quiz.server.answer(questionId, answer, userId, @Model.QuizID);
            });
            @if(Context.User.IsInRole(JLearnWeb.Constant.ConstantFields.Lecturer))
                {
                    @:quiz.server.start(@Model.QuizID);
                }
                else
                {
                    @:quiz.server.getCurrentQuestion(@Model.QuizID);
                }
            });
        });
        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div/>').text(value).html();
            return encodedValue;
        }

        function displayQuestion(value) {
            $('#notification').html('');
            if(value == null) {
                $('#submitAnswer').prop('disabled', true);
                return;
            } else {
                $('#submitAnswer').prop('disabled', false);
            }

            $('#questionHeader').html('Question ' + value.CurrentQuestionIndex + ' / ' + value.TotalQuestions);

            var body = value.Title;
            $.each(value.Choice, function(i, item) {
                body += '<div class="radio"><label><input type="hidden" name="questionId" id="questionId" value="' + value.QuestionID + '" /><input type="radio" name="optionsRadios" value="' + item.ChoiceID + '"> ' + item.Choice + '</label></div>';
            });

            $('#choice').html(body);

            if (value.CurrentQuestionIndex == value.TotalQuestions) {
                $('#next').prop('disabled', true);
            } else {
                $('#next').prop('disabled', false);
            }

            if (value.CurrentQuestionIndex == 1) {
                $('#prev').prop('disabled', true);
            } else {
                $('#prev').prop('disabled', false);
            }
        }
    </script>

    @if (Context.User.IsInRole(JLearnWeb.Constant.ConstantFields.Lecturer))
    {
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <script type="text/javascript">
            google.charts.load('current', { packages: ['corechart', 'bar'] });

            function drawChart(stats) {
                var data = google.visualization.arrayToDataTable([
                    ['Question', 'Answer'],
                    ['A', stats[0].Count],
                    ['B', stats[1].Count],
                    ['C', stats[2].Count],
                    ['D', stats[3].Count]
                ]);

                var options = {
                    legend: { position: 'none' },
                    vAxis: { minValue:0, maxValue:5, gridlines:{count:6}, format:'0' },
                };

                var chart = new google.visualization.ColumnChart(
                  document.getElementById('chart_div'));

                chart.draw(data, options);
            }
        </script>
    }
}

<div class="row">
    <div class="page-header page-heading">
        <h2>Quiz 1</h2>
    </div>
    <div id="notification"></div>
    @if (Context.User.IsInRole(JLearnWeb.Constant.ConstantFields.Lecturer))
    {
        <div class="col-md-6">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        Statistic
                    </h3>
                </div>
                <div class="panel-body">
                    <div id="chart_div"></div>
                </div>
            </div>
        </div>
    }
    <div class="col-md-6">
        <div class="panel panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title" id="questionHeader">
                    Quiz Not Yet Started
                </h3>
            </div>
            <div class="panel-body" id="choice">
            </div>
            <div class="panel-footer" id="button-footer">
                @if (Context.User.IsInRole(JLearnWeb.Constant.ConstantFields.Lecturer))
                {
                    <button type="button" class="btn btn-default" id="prev">Prev</button>
                    <button type="button" class="btn btn-default" id="next">Next</button>
                }
                else
                {
                    <button type="button" class="btn btn-primary" id="submitAnswer">Submit</button>
                }
            </div>
        </div>
    </div>
</div>