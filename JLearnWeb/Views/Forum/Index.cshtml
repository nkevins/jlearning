@model DL.ForumThread

<div class="row">
    <div class="page-header">
        <h2>Live Forum Thread</h2>
    </div>
    <div class="col-md-2">
        @Html.Partial("_ScheduleMenuPartial", Model.ScheduleID)
    </div>
    <div class="col-md-10">
        <h1>@Model.Title</h1>
        <div class="chat-panel-body">
            <ul id="chatMessage" class="chat">
                @foreach (var p in @Model.ForumPosts.OrderByDescending(x => x.CreatedDate))
                {
                    <li class="left clearfix">
                        <div class="chat-body">
                            <div class="header">
                                <strong class="primary-font">@p.User.Name</strong> <small class="pull-right text-muted">
                                    <span class="glyphicon glyphicon-time"></span>@p.CreatedDate.Value.ToString("d/M/yyyy h:mm:ss tt")
                                </small>
                            </div>
                            <p>
                                @p.Description
                            </p>
                        </div>
                    </li>
                }
            </ul>
        </div>
        <div class="panel-footer">
            <div class="input-group">
                <textarea class="form-control" style="min-width: 80%" rows="3" placeholder="Type your message here..." id="message"></textarea>
                <span class="input-group-btn">
                    <button class="btn btn-warning btn-sm" id="post">
                        Post
                    </button>
                </span>
            </div>
        </div>
    </div>
</div>
@section scripts {
    <!--Script references. -->
    <script src="~/Scripts/moment.min.js"></script>
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $(function () {
            // Reference the auto-generated proxy for the hub.
            var chat = $.connection.forumHub;
            // Create a function that the hub can call back to display messages.
            chat.client.broadcast = function (forumId, message) {
                // Add the message to the page.
                if(forumId == @Model.ForumThreadID) {
                    var msg = JSON.parse(message);
                    var postDate = moment(msg.CreatedDate);
                    var formattedDate = postDate.format('D/M/YYYY h:mm:ss A');
                    $('#chatMessage').prepend('<li class="left clearfix"><div class="chat-body"><div class="header"><strong class="primary-font">' + htmlEncode(msg.Name) + '</strong> <small class="pull-right text-muted"><span class="glyphicon glyphicon-time"></span>' + formattedDate + '</small></div><p>' + htmlEncode(msg.Message) + '</p></div></li>');
                }
            };
            // Set initial focus to message input box.
            $('#message').focus();
            // Start the connection.
            $.connection.hub.start().done(function () {
                $('#post').click(function () {
                    if($('#message').val() != '') {
                        // Call the Send method on the hub.
                        chat.server.sendMessage(@Model.ForumThreadID, $('#message').val(), @ViewBag.UserId);
                        // Clear text box and reset focus for next comment.
                        $('#message').val('').focus();
                    }
                });
            });
        });
        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div/>').text(value).html();
            return encodedValue;
        }
    </script>
}